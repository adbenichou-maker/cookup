<%
  # Determine which buttons to show based on conversation state
  # Check the last user message to determine current state:
  # - If last user message is "Select Option X" -> show Save/New Recipes
  # - If last user message is "Give me 3 more recipes" -> show option buttons
  # - Otherwise check if any "Select Option" exists after the last "Give me 3 more"
  user_messages = @chat.messages.where(role: "user").order(:created_at)
  last_user_message = user_messages.last

  # Find the index of the last "new recipes" request
  last_new_recipes_index = user_messages.to_a.rindex { |m| m.content.match?(/give me 3 more recipes/i) }

  # Check if there's a "Select Option" after the last "new recipes" request
  has_selected_recipe = if last_new_recipes_index
    # Only look at messages after the last "new recipes" request
    user_messages.to_a[(last_new_recipes_index + 1)..-1]&.any? { |m| m.content.match?(/Select Option \d/i) }
  else
    # No "new recipes" request yet, check all messages
    user_messages.any? { |m| m.content.match?(/Select Option \d/i) }
  end

  assistant_messages = @chat.messages.where(role: "assistant")
  last_assistant_message = assistant_messages.last
%>

<div class="chat-container"
    data-controller="autoscroll chat-typing"
    data-chat-typing-target="messages">

  <div id="messages" data-autoscroll-target="messages">
    <% @chat.messages.order(:created_at).each do |message| %>

      <% if message.role == "user" %>
        <div class="message-row">
          <div class="chat-bubble chat-user">
            <%= message.content %>
          </div>
        </div>

      <% else %>
        <div class="message-row" data-latest-assistant="true">
          <div class="chat-bubble chat-assistant">
            <%= raw(render_markdown(message.content)) %>
          </div>
        </div>
      <% end %>

    <% end %>

    <!-- Typing indicator inside messages so it scrolls with content -->
    <div id="typing-indicator" class="typing-indicator hidden">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
  </div>

  <%= simple_form_for [@chat, @message],
      html: {
        class: "chat-form",
        data: {
          controller: "chat-form-loading",
          action: "submit->chat-typing#showTyping submit->chat-form-loading#disable"
        }
      } do |f| %>

    <div class="chat-buttons-row" data-chat-form-loading-target="buttons">

      <% if has_selected_recipe %>
        <%# User has selected a recipe - show Save and New Recipes buttons %>

        <% if last_assistant_message %>
          <%= link_to message_recipes_path(last_assistant_message),
              data: { turbo_method: "post" },
              class: "chat-form-save-btn" do %>
            <i class="fas fa-bookmark"></i>
            Save Recipe
          <% end %>
        <% end %>

        <%= f.button :submit, "New Recipes",
            class: "chat-new-recipes-btn",
            name: "message[content]",
            value: "Give me 3 more recipes",
            data: { chat_form_loading_target: "submitBtn" } %>

      <% else %>
        <%# Initial state - show 3 option buttons %>

        <%= f.button :submit, "Option 1",
            class: "chat-option-btn",
            value: "Select Option 1",
            name: "message[content]",
            data: { chat_form_loading_target: "submitBtn" } %>

        <%= f.button :submit, "Option 2",
            class: "chat-option-btn",
            value: "Select Option 2",
            name: "message[content]",
            data: { chat_form_loading_target: "submitBtn" } %>

        <%= f.button :submit, "Option 3",
            class: "chat-option-btn",
            value: "Select Option 3",
            name: "message[content]",
            data: { chat_form_loading_target: "submitBtn" } %>

      <% end %>

    </div>

  <% end %>

</div>
