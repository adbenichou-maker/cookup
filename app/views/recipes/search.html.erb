<div class="search-page-container" data-controller="filter">

  <!-- Back button -->
  <%= link_to dashboard_path, class: "profile-back" do %>
    <i class="fa-solid fa-arrow-left"></i>
  <% end %>

  <!-- Title -->
  <h1 class="search-title">What do you want to cook?</h1>

  <!-- Search Bar -->
  <div class="search-bar-wrapper">
    <%= form_with url: recipes_search_path, method: :get, local: true, class: "search-form", id: "cookbook-search-form" do |f| %>
      <%= f.text_field :query, placeholder: "Search", class: "search-input", value: @query %>
        <button type="button" data-action="click->filter#toggle" data-filter-target="button" class="filter-btn"><i class="fa-solid fa-filter"></i></button>
      <% end %>

      <button type="submit" form="cookbook-search-form" class="search-submit-btn">Search</button>
    </div>

  <!-- Filter Panel -->
  <div data-filter-target="panel" class="filter-panel hidden">

    <%= form_with url: recipes_search_path, method: :get, local: true do |f| %>

      <!-- Difficulty Filter -->
      <h4>Difficulty</h4>

      <div data-controller="difficultySlider" class="difficulty-wrapper">

        <input
          type="range"
          min="0"
          max="2"
          step="1"
          value="<%= params[:level] %>"
          class="difficulty-slider"
          data-action="input->difficultySlider#update"
          data-difficultySlider-target="slider"
        >

        <div class="difficulty-label" data-difficultySlider-target="label">
          Beginner
        </div>

        <%= f.hidden_field :level, value: params[:level], data: { difficultySlider_target: "input" } %>
      </div>


      <!-- Prep Time -->
      <h4>Prep Time</h4>

      <div data-controller="prepTime" class="prep-time-wrapper">

        <input
          type="range"
          min="0"
          max="120"
          step="5"
          value="<%= params[:prep_time] || 120 %>"
          class="prep-time-slider"
          data-action="input->prepTime#update"
          data-prepTime-target="slider"
        >

        <div class="prep-time-label" data-prepTime-target="label">
          <%= (params[:prep_time].to_i == 120 || params[:prep_time].blank?) ? "No limit" : "#{params[:prep_time]} min" %>
        </div>

        <%= f.hidden_field :prep_time, value: params[:prep_time] || 120, data: { prepTime_target: "input" } %>
      </div>

      <%= f.submit "Apply Filters", class: "search-submit-btn" %>

    <% end %>   <!-- ✅ THIS WAS MISSING -->

  </div>


  <!-- Results -->
  <% @recipes.each do |recipe| %>
    <div class="recipe-card">

      <!-- Clickable recipe section -->
      <%= link_to recipe_path(recipe), class: "recipe-main" do %>
        <div class="recipe-image-placeholder fa-solid fa-utensils"></div>

        <div class="recipe-text">
          <h3><%= recipe.title %></h3>
          <p><%= recipe.description %></p>

          <div class="rating">
            <% full_stars = recipe.average_rating.round %>
            <% empty_stars = 5 - full_stars %>

            <% full_stars.times { %> ★ <% } %>
            <% empty_stars.times { %> ☆ <% } %>

            <small>(<%= recipe.reviews.count %> reviews)</small>
          </div>
        </div>
      <% end %>

      <!-- Favorite Button (Turbo Frame prevents scroll jump) -->
      <turbo-frame id="favorite_button_<%= recipe.id %>">
        <%= render "favorites/favorite_button", recipe: recipe %>
      </turbo-frame>

    </div>
  <% end %>

</div>
