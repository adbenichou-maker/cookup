<div class="container-fluid p-3" style="background-color: #F7EEDB; min-height: 100vh;">

  <!-- Back Button -->
  <%= link_to recipes_search_path, class: "profile-back" do %>
    <i class="fa-solid fa-arrow-left"></i>
  <% end %>

  <!-- Header -->
  <header class="mb-4 pt-3">
    <div class="text-center">
      <h1 class="display-5 fw-bold mb-2" style="color: #4A4A4A;">
        <%= @recipe.title %>
      </h1>

      <% if @recipe.description.present? %>
        <p class="mb-3" style="color: #4A4A4A; font-size: 1em; opacity: 0.8;">
          <%= @recipe.description %>
        </p>
      <% end %>

      <!-- Meta Badges -->
      <div class="d-flex justify-content-center align-items-center gap-2 flex-wrap">
        <% if @recipe.meal_prep_time.present? %>
          <div class="d-inline-flex align-items-center px-3 py-2 rounded-pill shadow-sm"
               style="background-color: #C9815B; color: #FFFFFF;">
            <i class="fa-regular fa-clock me-2"></i>
            <span class="fw-bold">
              <%= @recipe.meal_prep_time >= 60 ? '1hr +' : "#{@recipe.meal_prep_time} min" %>
            </span>
          </div>
        <% end %>

        <% if @recipe.recipe_level.present? %>
          <%
            level_map = { "beginner" => 'Beginner', "intermediate" => 'Intermediate', "expert" => 'Expert' }
            level_text = level_map[@recipe.recipe_level.to_i] || @recipe.recipe_level.to_s.capitalize
            level_key = level_text.downcase
            badge_bg = case level_key
                      when "beginner" then "#8BAA7B"
                      when "intermediate" then "#F2C94C"
                      when "expert" then "#C9815B"
                      else "#8BAA7B"
                      end
            badge_text = level_key == "intermediate" ? "#141111ff" : "#FFFFFF"
          %>
          <div class="d-inline-flex align-items-center px-3 py-2 rounded-pill shadow-sm"
              style="background-color: <%= badge_bg %>; color: <%= badge_text %>;">
            <i class="fa-solid fa-graduation-cap me-2"></i>
            <span class="fw-bold"><%= level_text %></span>
          </div>
        <% end %>
      </div>
    </div>
    <hr class="mt-4" style="border-color: #8BAA7B;">
  </header>

  <div class="row justify-content-center">
    <div class="col-12 col-md-8">

      <!-- Ingredients Section -->
      <section class="card shadow-sm mb-4 border-0" style="border-radius: 16px; overflow: hidden;">
        <div class="card-header text-white py-3" style="background-color: #8BAA7B;">
          <h2 class="h5 mb-0 fw-bold">
            <i class="fa-solid fa-basket-shopping me-2"></i>Ingredients
          </h2>
        </div>
        <ul class="list-group list-group-flush">
          <% @recipe.ingredients.each do |name, quantity| %>
            <li class="list-group-item d-flex justify-content-between align-items-center py-3"
                style="background-color: #FCF8EF;">
              <span class="fw-bold" style="color: #4A4A4A;"><%= name.to_s.humanize %></span>
              <span class="badge rounded-pill px-3 py-2" style="background-color: #C9815B; color: #FFFFFF;">
                <%= quantity %>
              </span>
            </li>
          <% end %>
        </ul>
      </section>

      <!-- Skills Section -->
      <%
        @skills_for_recipe = @recipe.steps.select { |step| step.skill.present? }.map(&:skill).uniq
      %>

      <% if @skills_for_recipe.any? %>
        <section class="card shadow-sm mb-4 border-0" style="border-radius: 16px; overflow: hidden;">
          <div class="card-header text-white py-3" style="background-color: #C9815B;">
            <h2 class="h5 mb-0 fw-bold">
              <i class="fa-solid fa-wand-magic-sparkles me-2"></i>Key Techniques
            </h2>
          </div>
          <div class="card-body p-3" style="background-color: #FCF8EF;">
            <div class="d-flex flex-wrap gap-2">
              <% @skills_for_recipe.each do |skill| %>
                <%= link_to skill_path(skill, recipe_id: @recipe.id), style: "text-decoration: none;" do %>
                  <div class="d-inline-flex align-items-center px-3 py-2 rounded-pill shadow-sm"
                      style="background-color: #F2C94C; transition: transform 0.2s ease;">
                    <i class="fa-solid fa-star me-2" style="color: #C9815B;"></i>
                    <span class="fw-bold" style="color: #4A4A4A;"><%= skill.title %></span>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </section>
      <% end %>

      <!-- Start Cooking Button -->
      <div class="d-grid mb-4">
        <%= link_to recipe_steps_path(@recipe),
            class: "btn btn-lg fw-bold text-white shadow-lg",
            style: "background-color: #8BAA7B; border-color: #8BAA7B; border-radius: 12px; padding: 16px;" do %>
          <i class="fa-solid fa-fire-burner me-2"></i>START COOKING
        <% end %>
      </div>

      <!-- Reviews Section -->
      <section class="card shadow-sm mb-5 border-0" style="border-radius: 16px; overflow: hidden;">
        <div class="accordion" id="reviewsAccordion">
          <div class="accordion-item border-0">
            <h2 class="accordion-header">
              <button class="accordion-button fw-bold collapsed py-3"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseAllReviews"
                      aria-expanded="false"
                      aria-controls="collapseAllReviews"
                      style="background-color: #F2C94C; color: #4A4A4A;">
                <i class="fa-solid fa-star me-2"></i>
                Reviews (<%= @recipe.reviews.count %>)
              </button>
            </h2>

            <div id="collapseAllReviews" class="accordion-collapse collapse show" data-bs-parent="#reviewsAccordion">
              <div class="accordion-body p-3" style="background-color: #FCF8EF;">

                <% if @recipe.reviews.any? %>
                  <% @recipe.reviews.each do |review| %>
                    <% next unless review.persisted? %>

                    <div class="card border-0 shadow-sm mb-3" style="border-radius: 12px; overflow: hidden;">
                      <div class="card-body p-3" style="background-color: #FFFFFF;">
                        <div class="d-flex justify-content-between align-items-start">

                          <div class="flex-grow-1 me-3">
                            <div class="d-flex align-items-center mb-2">
                              <div class="d-inline-flex align-items-center justify-content-center rounded-circle me-2"
                                  style="width: 36px; height: 36px; background-color: rgba(139, 170, 123, 0.15);">
                                <i class="fa-solid fa-user" style="color: #8BAA7B;"></i>
                              </div>
                              <div>
                                <h6 class="fw-bold mb-0" style="color: #4A4A4A;"><%= review.title %></h6>
                                <small style="color: #C9815B;">
                                  By <%= review.user.present? ? review.user.username : 'Unknown User' %>
                                </small>
                              </div>
                            </div>

                            <p class="mb-2" style="color: #4A4A4A; line-height: 1.6;"><%= review.comment %></p>

                            <div class="d-flex align-items-center">
                              <% review.rate.times do %>
                                <i class="fa-solid fa-star me-1" style="color: #F2C94C;"></i>
                              <% end %>
                              <% (5 - review.rate).times do %>
                                <i class="fa-regular fa-star me-1" style="color: #F2C94C;"></i>
                              <% end %>
                            </div>
                          </div>

                          <% if user_signed_in? && (review.user == current_user) %>
                            <%= button_to recipe_review_path(@recipe, review),
                                method: :delete,
                                data: { turbo_confirm: "Are you sure you want to delete this review?" },
                                class: "btn p-0 d-flex align-items-center justify-content-center",
                                style: "width: 32px; height: 32px; border-radius: 50%; background-color: rgba(201, 129, 91, 0.1); border: none;" do %>
                              <i class="fa-solid fa-trash-can" style="color: #C9815B; font-size: 14px;"></i>
                            <% end %>
                          <% end %>

                        </div>
                      </div>
                    </div>
                  <% end %>
                <% else %>
                  <div class="text-center py-4">
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3"
                         style="width: 64px; height: 64px; background-color: rgba(242, 201, 76, 0.15);">
                      <i class="fa-regular fa-comment fa-2x" style="color: #F2C94C;"></i>
                    </div>
                    <p class="mb-0 fw-bold" style="color: #4A4A4A;">No reviews yet</p>
                    <small style="color: #C9815B;">Be the first to share your thoughts!</small>
                  </div>
                <% end %>

              </div>
            </div>

          </div>
        </div>
      </section>

    </div>
  </div>
</div>
